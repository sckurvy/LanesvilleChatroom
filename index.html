<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Local Chat Room</title>
  <style>
    :root{
      --bg:#0f1724; --panel:#0b1220; --muted:#9aa4b2; --text:#e6eef6; --accent:#5865f2;
    }
    [data-theme="light"]{ --bg:#f4f7fb; --panel:#ffffff; --muted:#6b7280; --text:#0b1220; --accent:#4f46e5; }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
    body{background:linear-gradient(180deg,var(--bg),#071022);color:var(--text);display:flex;align-items:center;justify-content:center;padding:28px}

    .app{width:960px;max-width:96vw;height:76vh;display:grid;grid-template-rows:64px 1fr 96px;border-radius:12px;overflow:hidden;background:linear-gradient(180deg,var(--panel),rgba(255,255,255,0.02));box-shadow:0 10px 30px rgba(2,6,23,0.6)}

    /* header */
    header{display:flex;align-items:center;justify-content:space-between;padding:0 18px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .title{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#1f8ef1);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:18px}
    .hdr-text{display:flex;flex-direction:column}
    .hdr-text .main{font-weight:600}
    .hdr-text .sub{font-size:12px;color:var(--muted)}

    .controls{display:flex;gap:10px;align-items:center}
    .icon-btn{width:40px;height:40px;border-radius:10px;border:0;background:transparent;color:var(--text);cursor:pointer;display:inline-flex;align-items:center;justify-content:center}

    /* messages */
    .messages{padding:16px 18px;overflow:auto}
    .msg{display:flex;gap:12px;padding:8px;border-radius:8px;margin-bottom:6px}
    .avatar{width:44px;height:44px;border-radius:999px;background:linear-gradient(135deg,#2b6bff,#8e44ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
    .bubble{background:rgba(255,255,255,0.02);padding:8px 12px;border-radius:8px;min-width:0}
    .meta{display:flex;align-items:center;gap:10px}
    .name{font-weight:700}
    .time{font-size:12px;color:var(--muted)}
    .text{margin-top:6px;white-space:pre-wrap;color:var(--text)}

    /* composer */
    .composer{padding:14px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:12px;align-items:flex-end}
    .input-wrap{flex:1}
    .input{width:100%;min-height:56px;max-height:140px;border-radius:16px;padding:12px 14px;border:0;outline:none;resize:none;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);color:var(--text);box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
    .send{background:var(--accent);border:0;padding:12px 16px;border-radius:12px;color:white;font-weight:600;cursor:pointer}
    .send:disabled{opacity:0.5;cursor:not-allowed}

    /* Welcome / set name overlay */
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,0.6)}
    .card{background:var(--panel);padding:22px;border-radius:12px;max-width:520px;width:92%;box-shadow:0 10px 40px rgba(2,6,23,0.6)}
    .card h2{margin:0 0 8px 0}
    .row{display:flex;gap:10px;margin-top:12px}
    .field{flex:1}
    .txt{width:100%;padding:10px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:var(--text)}
    .btn{padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}

    /* settings */
    .settings-panel{position:absolute;top:74px;right:18px;background:var(--panel);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);min-width:220px;box-shadow:0 6px 20px rgba(2,6,23,0.5)}
    .settings-panel label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    .theme-row{display:flex;gap:8px}
    .theme-option{flex:1;padding:8px;border-radius:8px;text-align:center;cursor:pointer;border:1px solid transparent}
    .theme-option.active{outline:2px solid rgba(88,101,242,0.14)}

    @media (max-width:640px){.app{height:86vh;width:96vw}}
  </style>
</head>
<body data-theme="dark">
  <div class="app" role="application">
    <header>
      <div class="title">
        <div class="logo">C</div>
        <div class="hdr-text">
          <div class="main">Local Chat Room</div>
          <div class="sub">Messages are saved locally — only on this device</div>
        </div>
      </div>

      <div class="controls">
        <button id="settingsBtn" class="icon-btn" title="Settings">⚙️</button>
      </div>
    </header>

    <main class="messages" id="messages" aria-live="polite"></main>

    <form id="composer" class="composer" onsubmit="return false;">
      <div class="input-wrap">
        <textarea id="msgInput" class="input" placeholder="Message (Enter to send — Shift+Enter for newline)"></textarea>
      </div>
      <div>
        <button id="sendBtn" class="send" type="submit">Send</button>
      </div>
    </form>

    <!-- settings panel (hidden by default) -->
    <div id="settings" class="settings-panel" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <strong>Settings</strong>
        <button id="closeSettings" class="icon-btn" title="Close">✖</button>
      </div>
      <div>
        <label for="displayName">Display name</label>
        <input id="displayName" class="txt" placeholder="Your name" />
        <div style="margin-top:10px;text-align:right"><button id="saveName" class="btn">Save</button></div>
      </div>
      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">
      <div>
        <label>Theme</label>
        <div class="theme-row">
          <div id="themeDark" class="theme-option active">Dark</div>
          <div id="themeLight" class="theme-option">Light</div>
        </div>
      </div>
      <div style="margin-top:8px">
        <label>Accent color</label>
        <div style="display:flex;gap:8px">
          <button class="theme-option" data-color="#5865f2">Blue</button>
          <button class="theme-option" data-color="#1f8ef1">Sky</button>
          <button class="theme-option" data-color="#22c55e">Green</button>
          <button class="theme-option" data-color="#ef4444">Red</button>
        </div>
      </div>
    </div>

  </div>

  <!-- name overlay -->
  <div id="overlay" class="overlay" style="display:none;">
    <div class="card">
      <h2>Welcome</h2>
      <p>Enter a display name to join the local chat. Your name and messages are saved on this device only.</p>
      <div class="row" style="margin-top:12px">
        <input id="nameInput" class="txt field" placeholder="Display name" maxlength="32" />
        <button id="startBtn" class="btn">Join</button>
      </div>
    </div>
  </div>

  <script>
    // localStorage keys
    const KEY_NAME = 'local_chat_name_v1';
    const KEY_MSGS = 'local_chat_messages_v1';
    const KEY_THEME = 'local_chat_theme_v1';
    const KEY_ACCENT = 'local_chat_accent_v1';

    // elements
    const overlay = document.getElementById('overlay');
    const nameInput = document.getElementById('nameInput');
    const startBtn = document.getElementById('startBtn');
    const displayNameInput = document.getElementById('displayName');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settings');
    const closeSettings = document.getElementById('closeSettings');
    const themeDark = document.getElementById('themeDark');
    const themeLight = document.getElementById('themeLight');
    const messagesEl = document.getElementById('messages');
    const composer = document.getElementById('composer');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');

    // state
    let name = localStorage.getItem(KEY_NAME) || '';
    let messages = JSON.parse(localStorage.getItem(KEY_MSGS) || '[]');
    let theme = localStorage.getItem(KEY_THEME) || 'dark';
    let accent = localStorage.getItem(KEY_ACCENT) || null;

    // init
    document.body.setAttribute('data-theme', theme === 'light' ? 'light' : 'dark');
    if (accent) document.documentElement.style.setProperty('--accent', accent);
    if (!name) showOverlay();
    else displayNameInput.value = name;
    renderMessages();

    // helpers
    function showOverlay(){ overlay.style.display = 'flex'; nameInput.focus(); }
    function hideOverlay(){ overlay.style.display = 'none'; }

    function saveName(n){ name = n.trim() || 'Anonymous'; localStorage.setItem(KEY_NAME, name); displayNameInput.value = name; }

    function addMessage(text){
      if (!text.trim()) return;
      const msg = {id: Date.now() + Math.random().toString(36).slice(2,7), name, text, ts: new Date().toISOString()};
      messages.push(msg);
      localStorage.setItem(KEY_MSGS, JSON.stringify(messages));
      appendMessage(msg);
      msgInput.value = '';
      msgInput.style.height = '';
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function formatTimestamp(iso){
      const d = new Date(iso);
      // e.g. Aug 11, 2025 • 10:07 PM
      const opt = {month:'short', day:'numeric', year:'numeric'};
      const datePart = d.toLocaleDateString(undefined,opt);
      let hours = d.getHours();
      const minutes = String(d.getMinutes()).padStart(2,'0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12 || 12;
      return `${datePart} • ${hours}:${minutes} ${ampm}`;
    }

    function initialsFor(name){
      const parts = name.split(/\s+/).filter(Boolean);
      if (!parts.length) return 'U';
      return (parts[0][0] + (parts[1] ? parts[1][0] : '')).toUpperCase();
    }

    function appendMessage(m){
      const el = document.createElement('div'); el.className='msg';
      el.innerHTML = `
        <div class="avatar" aria-hidden="true">${initialsFor(m.name)}</div>
        <div class="bubble">
          <div class="meta"><div class="name">${escapeHtml(m.name)}</div><div class="time">${formatTimestamp(m.ts)}</div></div>
          <div class="text">${escapeHtml(m.text)}</div>
        </div>
      `;
      messagesEl.appendChild(el);
    }

    function renderMessages(){ messagesEl.innerHTML=''; messages.forEach(appendMessage); messagesEl.scrollTop = messagesEl.scrollHeight; }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }

    // events
    startBtn.addEventListener('click', ()=>{ const v = nameInput.value.trim(); if (!v) return nameInput.focus(); saveName(v); hideOverlay(); });
    nameInput.addEventListener('keydown', e=>{ if (e.key === 'Enter'){ e.preventDefault(); startBtn.click(); } });

    settingsBtn.addEventListener('click', ()=>{ settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none'; displayNameInput.focus(); displayNameInput.select(); });
    closeSettings.addEventListener('click', ()=> settingsPanel.style.display='none');

    document.getElementById('saveName').addEventListener('click', ()=>{ const v = displayNameInput.value.trim(); if (!v) return; saveName(v); settingsPanel.style.display='none'; });

    themeDark.addEventListener('click', ()=>{ setTheme('dark'); themeDark.classList.add('active'); themeLight.classList.remove('active'); });
    themeLight.addEventListener('click', ()=>{ setTheme('light'); themeLight.classList.add('active'); themeDark.classList.remove('active'); });

    document.querySelectorAll('.settings-panel .theme-option[data-color]').forEach(btn=>{
      btn.addEventListener('click', ()=>{ const c = btn.getAttribute('data-color'); document.documentElement.style.setProperty('--accent', c); localStorage.setItem(KEY_ACCENT, c); });
    });

    function setTheme(t){ theme = t; localStorage.setItem(KEY_THEME, t); document.body.setAttribute('data-theme', t === 'light' ? 'light' : 'dark'); }

    // composer
    composer.addEventListener('submit', ()=>{ sendBtn.click(); });
    sendBtn.addEventListener('click', ()=>{ addMessage(msgInput.value); });

    msgInput.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
    });

    // auto-resize textarea
    msgInput.addEventListener('input', ()=>{ msgInput.style.height='auto'; msgInput.style.height = msgInput.scrollHeight + 'px'; });

    // export/import (not shown in UI — for advanced users via console)
    // window.localChat = { messages, save: ()=> localStorage.setItem(KEY_MSGS, JSON.stringify(messages)), load: ()=>{ messages = JSON.parse(localStorage.getItem(KEY_MSGS)||'[]'); renderMessages(); } };

    // allow clearing with long press on logo (for dev/testing)
    document.querySelector('.logo').addEventListener('dblclick', ()=>{
      if (!confirm('Clear all local messages and name?')) return; localStorage.removeItem(KEY_MSGS); localStorage.removeItem(KEY_NAME); messages=[]; name=''; renderMessages(); showOverlay();
    });

  </script>
</body>
</html>
